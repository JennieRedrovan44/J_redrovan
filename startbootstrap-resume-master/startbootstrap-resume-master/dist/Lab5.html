<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Jennie Redrovan</title>
        <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
            <a class="navbar-brand js-scroll-trigger" href="#about">
                <span class="d-block d-lg-none">Jennie Redrovan</span>
                <span class="d-none d-lg-block">
                    <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="assets/img/Picofme.png" alt="Profile Picture" />
                </span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="index.html">About</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab1a.html">Lab 1A: Artemis</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab1B.html">Lab 1B: Bluetooth</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab2.html">Lab 2: IMU</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab3.html">Lab 3: TOF</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab4.html">Lab 4: Motor Drivers, Open Loop Control</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab5.html"style="color: rgb(255, 255, 255);">Lab 5: Speed Control</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab6.html">Lab 6: Orientation Control</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab7.html">Lab 7: Kalman Filter</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab8.html">Lab 8: Stunts!</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab9.html">Lab 9: Mapping</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab10.html">Lab 10: Bayes Filter (Sim)</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab11.html">Lab 11: Localization (Real)</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="Lab12.html">Lab 12: Path Planning</a></li>
                </ul>
            </div>
        </nav>

        <section class="resume-section" id="about">
            <div class="resume-section-content">
                <h2 class="mb-2">Lab 5 : <span class="text-primary">Linear PID control and Linear interpolation</span></h2>
                <!--Prelab-->
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <h3 class="mb-0">Before the Prelab:</h3>
                        <p>
                            Before starting the prelab, I had to separate my code into different C++ header files. Like Stephan, I was getting tired of constantly 
                            scrolling and keeping track of all my initializations at the beginning of my code. 
                            Managing everything in one place was becoming overwhelming. So, I decided to separate my code into different files to keep everything organized. 
                            This allowed me to keep everything structured and made it easier for me to navigate.<br><br>
                            I created header files for ble.hpp, imu.hpp, tof.hpp, motors.hpp, cmd_types.h. For this lab, I created another header called PID.hpp. <br><br>
                            Finally, I modified ble.arduino.ino to move the initializations of BLE and TOF into the setup function for better organization. <br><br>
                            
                            <h4>Prelab</h4>
                            Now that I had a better structure of my code, I was ready to start the prelab. <br><br>
                            Firstly, I created new commands specifically, I created start_PID, stop_PID, SEND_PID_DATA. <br><br>
                            <strong>For start_PID:</strong> <br><br>
                            I created a new command called start_PID which is used to start the PID controller. <br><br>
                            In this command, I set the run_PID_CASE to 1 which is used to start the PID controller. <br><br>
                            I also would set the desired speed, desired distance, kp, ki, kd to the values that I want to use for the PID controller. <br><br>
                            Sending the command from Jupyter notebook:<br><br>
                            <img src="assets/img_lab5/IMG_command_start_PID.png" alt="scanning" width="90%" /><br><br>
                            The case corresponding to the command: <br><br>
                            <img src="assets/img_lab5/IMG_command_start_PID_case.png" alt="scanning" width="90%" /><br><br>
                            <strong>For stop_PID:</strong> <br><br>
                            Sending the command from Jupyter notebook:<br><br>
                            <img src="assets/img_lab5/IMG_command_stop_PID.png" alt="scanning" width="50%" /><br><br>
                            The case corresponding to the command: <br><br>
                            <img src="assets/img_lab5/IMG_command_stop_PID_case.png" alt="scanning" width="50%" /><br><br>
                            When the command from Jupyter is sent to the robot, the robot will stop the PID controller given that run_PID_CASE will now be 0 (no longer true so loop will not run).<br><br>
                            <strong>For SEND_PID_DATA:</strong> <br><br>
                            Sending the command from Jupyter notebook:<br><br>
                            <img src="assets/img_lab5/IMG_command_send_PID.png" alt="scanning" width="90%" /><br><br>
                            The case corresponding to the command: <br><br>
                            <img src="assets/img_lab5/IMG_SEND_PID_DATA_PRELAB.png" alt="scanning" width="90%" /><br><br>
                            When the command from Jupyter is sent to the robot, the robot will send the PID data back to Jupyter notebook. I included the snippet on how the data is being processed as shown above.<br><br>

                            **If you calculate the time below, you can see my system can send data for over 5 seconds which is more than was required for the Prelab!**<br><br>
                    </div>
                </div>
                <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                    <div class="flex-grow-1">
                        <h3 class="mb-0">LAB: PID control</h3>  
                        <p>
                            Since I am a level 5000 student, I could choose between PI or PID. I choose to go with PID as I wanted to be able to control the car more accurately. <br><br>
                            The PID equation is shown below:<br><br>
                            <img src="assets/img_lab5/PID_equation.png" alt="scanning" width="50%" /><br><br>
                            The final code that I used throughout the lab is shown below:<br><br>
                            When the command from Jupyter is sent to the robot, the robot will start the PID controller given that run_PID_CASE will now be 1. Code snippet below:<br><br>
                            <img src="assets/img_lab5/FINAL_CODE.png" alt="scanning" width="90%" /><br><br>
                            The forward and backward functions are called in the PID_start function, the corresponding code snippet is shown below:<br><br>
                            <img src="assets/img_lab5/IMG_start_PID_PRELAB_forward.png" alt="scanning" width="90%" /><br><br>
                            <img src="assets/img_lab5/IMG_start_PID_PRELAB_backward.png" alt="scanning" width="90%" /><br><br>
                            
                            In each of my tunings what I defined as successful was that my robot was able to approach the wall without collisions, was able to reach the set distance, and can exhibit minimal oscillations. <br><br>
                        
                            <h2 class="mb-0">Implementing Kp </h2>  
                            The proportional gain (Kp) is the difference between the setpoint and the TOF reading.The setpoint that was used was 304mm (which is about 1ft away from the wall). <br><br>
                            I set the ki and kd to 0 in the start_PID command for now as I wanted to see how the robot would behave with just the proportional gain. <br><br>
                            I tested kp at kp = .03, .04, and .05 <br><br>
                            I have included the plots and videos for each of the kp values below. <br><br>
                            <strong>Plots for kp=.03</strong><br><br>
                            <img src="assets/img_lab5/P_control_.03_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Video for kp=.03</strong><br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/W2ma6aJm4YM"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>
                            <strong>Plots for kp=.04</strong><br><br>
                            <img src="assets/img_lab5/P_control_.04_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Video for kp=.04</strong><br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/GK1A-jyfTDQ"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>
                            <strong>Plots for kp=.05</strong><br><br>
                            <img src="assets/img_lab5/P_control_.05_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Video for kp=.05</strong><br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/OY-cvsCoWHM"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>
                            For the plots and videos above, I calibrated wheels in order for the robot to move straight. <br><br>
                            I included a video of the robot with PID linear control with just the proportional gain without any calibration as shown below: <br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/1oEHYSnLzgk"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>
                            As you can see, the robot is not able to move straight. This is because the wheels are not calibrated. <br><br>
                            Also, I tried implementing a higher value for kp = .06 but the robot would hit the wall and flip over.<br><br>
                            
                            After analyzing the plots and videos, I decided to go with kp = .05 as it was the most stable since there was much less oscillations at the set distance, less overshoot, and was faster compared to kp=.03 and .04<br><br> 
                            Essentially, 
                            <h2 class="mb-0">Implementing Kd </h2> 
                            The derivative gain (Kd) is the rate of change of the error. This is used to reduce the overshoot and oscillations. <br><br>
                            I set the ki to 0 in the start_PID command for now as I wanted to see how the robot would behave with just the proportional and derivative gain. <br><br>
                            I kept kp = .05 and tested kd at kd = .03, .3, .5, 1, 5, 2, <br><br>
                            I have included the plots and videos for each of the kd values below. <br><br>
                            <strong>Plots for kd=.03</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_.03d_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Video for kd=.03</strong><br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/IWkntqjlTa8"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>
                            <strong>Plots for kd=.03</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_.3d_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Video for kd=.3</strong><br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/M_1-RB4Uh8Y"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>
                            <strong>Plots for kd=.03</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_1d_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Video for kd=1</strong><br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/xEe3u77blvw"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>
                            <strong>Plots for kd=.03</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_5d_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Video for kd=5</strong><br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/tWSaztsLPs0"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>

                            As you can see, at kd =.3 is where the robot is the most stable and has the least amount of oscillations. <br><br>
                            Especially compared at kd=5 where the robot was struggling and sluggish to get to 304mm setpoint. Also, I have to mention when looking at the plots, you can see that the oscialltions
                            as it settles to the setpoint is very minimal, but there are many spikes in the PID value. <br><br>
                            
                            <h2 class="mb-0">Implementing Ki </h2> 
                            Finally, I implemented ki. Before I added the ki, I notcied that the my car kept crashing into the wall or starting going crazy. I included a video of me sending a very small ki, and my car going super fast 
                            even though it is close to a wall. <br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/tHntxdakb4o"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>

                            The reason why this was occuring was becuase the integral gain (Ki) is the sum of the error over time. Hence, since it is adding and adding the error over time it will be incresing which will impact the speed that the robot goes and how fast the TOF is responding. 
                            As seen in the video, my car was speeding even though it is close to the wall. From there, I implemented the integrator windup, which protects the integrator from increasing excessively. The way I was able to protect against wind up was through contraining 
                            ki as shown below: <br><br>
                            <img src="assets/img_lab5/integrator.png" alt="scanning" width="90%" /><br><br>

                            I kept kp the same, but I tested different kd and ki. I will show plots for each experimentation, I did not take videos each time sadly: <br><br>

                            <strong>Plots for kd=.5 and ki=00000005</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_5d_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Plots for kd=.5 and ki=.00005</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_5d_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Plots for kd=1.4 and ki=.000003</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_5d_calibration.png" alt="scanning" width="90%" /><br><br>
                            <strong>Plots for kd=1.5 and ki=.000003</strong><br><br>
                            <img src="assets/img_lab5/PD_control_.05p_5d_calibration.png" alt="scanning" width="90%" /><br><br>
                            

                            So, for the plots shown above, specifically at kd=.5 and ki=00000005, my robot was able to reach the setpoint and did not overshoot. However, when I tried it the next day, that no longer worked. 
                            So, I went with the second best which was kd=1.5 and ki=.000003. With this controller it was more consistant and I was able repeat it multiple times as shown below. 
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/9hq9Bpgez_4"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>

                            <h2 class="mb-0">Extrapolation </h2> 
                            <strong> Frequency</strong>   <br><br>                         
                            In the beginning of the lab, I knew that I was having issues to the sampling period of the TOF. I figured out the reason why it was taking 1 sec (which is pretty long) 
                            for one sample of TOF data was becuase I did not have start rangining in my pervious code. When I added this one line, the time it took to sample data for one data point 
                            was 100ms or 10hz. Which is much faster compared to what I had previously! <br><br>
                            Code used to output the frequency:<br><br>
                            <img src="assets/img_lab5/IMG_frequency.png" alt="scanning" width="90%" /><br><br>
                            The frequency for the PID control was found to be around 8ms which is around 125hz. Since the frequency for the PID control is higher compared to that of what the TOF sensor is outputting. 
                            This implies that our PID control is faster than what our TOF sensor is outputting, and that would mean that the solution to this problem would be to use 
                            extrapolation in order to estimate the distance if the new data is not available. <br><br>
                            Code snippet: <br><br>
                            <img src="assets/img_lab5/extrapolated.png" alt="scanning" width="90%" /><br><br>
                            Plot of extraplotation: <br><br>
                            <img src="assets/img_lab5/PID_control_extraplotation.png" alt="scanning" width="90%" /><br><br>
                            Video of robot with extraplotation code: <br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/ox--PS_eXok"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>

                            <strong> Testing Final System</strong>   <br><br>
                            Using kp=.05, kd=1.5, and ki=.000003 I tested this system at different distance and surfaces as shown below: <br><br>
                            
                            At distance 3ft: <br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/ox--PS_eXok"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>

                            Plot at distance 3ft: <br><br>
                            <img src="assets/img_lab5/PID_control_final_3ft.png" alt="scanning" width="90%" /><br><br>

                            Video of distance about 5ft + carpet: <br><br>
                            <iframe
                            width="560"
                            height="315"
                            src="https://www.youtube.com/embed/Vyu9SLyy8mA"

                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                            </iframe><br><br>

                            Plot at distance about 5ft + carpet: <br><br>
                            <img src="assets/img_lab5/PID_control_final_carpet.png" alt="scanning" width="90%" /><br><br>

                            <strong>5000 Level Task: Wind-Up Protection </strong> <br><br>
                            Discussed above!


                            <h3 class="mb-0">Conclusion</h3>
                            I would say this lab was challenging in the fact that it was hard to predict what would be the best values for our system. 
                            I mean our robots can change, the batteries tend to die quick, so what I thought was good for a day I was working may have not been the best 
                            values as seen above. I mean when I saw the plots how my robot was able to have no overshoot and be able to stop at 1ft and have little to no oscillations was impressive. 
                            However, the next day, these values no longer worked. I guess it was a fluke. However, it showed me how our batteries just die so quick and can impact the performace of that of the wheels. <br><br>

                            References: I used Mikayla and Stephans as a reference to understand what we are looking for. I also used the help of chatGPT to help me figure out the best course of action to debug my system. 
                        </p>
                    </div>
                </div>

                